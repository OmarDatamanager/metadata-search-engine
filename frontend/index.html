<!DOCTYPE html>
<html lang="sv">

<head>
  <meta charset="UTF-8">
  <title>Metadata Sökmotor</title>
  <link rel="stylesheet" href="style.css?v=5">
</head>

<body>
  <h1>Metadata Sökmotor</h1>

  <!-- Search Bar -->
  <div class="search-bar">
    <select id="fileType" onchange="showFilters()">
      <option value="">Alla filer</option>
      <option value="image">Bilder</option>
      <option value="audio">Ljud</option>
      <option value="pdf">PDF</option>
      <option value="ppt">PowerPoint</option>
    </select>
    <input type="text" id="searchInput" placeholder="Sök...">
    <button onclick="search()">Sök</button>
  </div>

  <!-- Filters Container -->
  <div id="filtersContainer" class="filters-container" style="display: none;">
    <!-- ISO Range Filter -->
    <label for="isoRange">Filtrera ISO:</label>
    <select id="isoRange">
      <option value="all">Alla ISO</option>
      <option value="0-50">0-50</option>
      <option value="51-100">51-100</option>
      <option value="101-150">101-150</option>
      <option value="151-200">151-200</option>
      <option value="201-250">201-250</option>
      <option value="251-300">251-300</option>
    </select>

    <!-- f_number Filter -->
    <label for="fNumber">Filtrera Bländare (f):</label>
    <select id="fNumber">
      <option value="all">Alla f</option>
      <option value="<3">Mindre än 3</option>
      <option value="3">3</option>
      <option value="3.5">3.5</option>
      <option value="4">4</option>
      <option value="4.5">4.5</option>
      <option value="5">5</option>
      <option value="5.5">5.5</option>
      <option value="6">6</option>
      <option value="6.5">6.5</option>
      <option value="7">7</option>
      <option value="7.5">7.5</option>
      <option value="8">8</option>
      <option value="8.5">8.5</option>
      <option value="9">9</option>
      <option value="9.5">9.5</option>
      <option value="10">10</option>
      <option value=">10">Större än 10</option>
    </select>
  </div>

  <!-- Results -->
  <div id="results"></div>

  <script>
    function showFilters() {
      const type = document.getElementById('fileType').value;
      const filtersContainer = document.getElementById('filtersContainer');
      filtersContainer.style.display = (type === 'image') ? 'flex' : 'none';
    }

    async function search() {
      const query = document.getElementById('searchInput').value;
      const fileType = document.getElementById('fileType').value;
      const isoRange = document.getElementById('isoRange')?.value || 'all';
      const fNumber = document.getElementById('fNumber')?.value || 'all';

      let url = `/api/search?q=${encodeURIComponent(query)}&type=${fileType}`;
      if (fileType === 'image') {
        if (isoRange && isoRange !== 'all') url += `&isoRange=${isoRange}`;
        if (fNumber && fNumber !== 'all') url += `&fNumber=${fNumber}`;
      }

      const response = await fetch(url);
      const results = await response.json();

      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = results.map(file => {
        const metadata = file.metadata_json || {};

        function renderMetadata(obj, prefix = "") {
          if (!obj || typeof obj !== "object") return `<span>${obj}</span>`;
          let html = "";
          for (const key in obj) {
            if (obj[key] && typeof obj[key] === "object" && !Array.isArray(obj[key])) {
              html += `<p class="meta-field"><b>${prefix + key}:</b></p>` + renderMetadata(obj[key], prefix + key + ".");
            } else {
              html += `<p class="meta-field"><b>${prefix + key}:</b> ${obj[key] != null ? obj[key] : "-"}</p>`;
            }
          }
          return html;
        }

        const details = renderMetadata(metadata);

        let preview = "";
        if (file.file_type === "image") {
          preview = `<img src="files/image/${file.filename}" alt="${file.filename}" class="file-preview">`;
        } else if (file.file_type === "audio") {
          preview = `<audio controls class="file-preview">
                      <source src="files/audio/${file.filename}" type="audio/mpeg">
                      Din webbläsare stödjer inte ljuduppspelning.
                    </audio>`;
        }

        return `
          <div class="result-card">
            <h3>${file.filename}</h3>
            <p><b>Typ:</b> ${file.file_type}</p>
            ${preview}
            ${details}
          </div>
        `;
      }).join('');
    }
  </script>
</body>

</html>