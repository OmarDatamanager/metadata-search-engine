<!DOCTYPE html>
<html lang="sv">

<head>
  <meta charset="UTF-8">
  <title>Metadata Sökmotor</title>
  <link rel="stylesheet" href="style.css?v=2">
</head>

<body>
  <h1>Metadata Sökmotor</h1>

  <!-- Search Form -->
  <input type="text" id="searchInput" placeholder="Sök...">
  <select id="fileType">
    <option value="">Alla</option>
    <option value="image">Bilder</option>
    <option value="audio">Ljud</option>
    <option value="pdf">PDF</option>
    <option value="ppt">PowerPoint</option>
  </select>

  <button onclick="search()">Sök</button>

  <div id="results"></div>

  <script>
    async function search() {
      const query = document.getElementById('searchInput').value;
      const fileType = document.getElementById('fileType').value;

      const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&type=${fileType}`);
      const results = await response.json();

      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = results.map(file => {
        const metadata = file.metadata_json || {};

        // Function to render metadata recursively
        function renderMetadata(obj, prefix = "") {
          if (!obj || typeof obj !== "object") return `<span>${obj}</span>`;
          let html = "";
          for (const key in obj) {
            if (obj[key] && typeof obj[key] === "object" && !Array.isArray(obj[key])) {
              html += `<p class="meta-field"><b>${prefix + key}:</b></p>` + renderMetadata(obj[key], prefix + key + ".");
            } else {
              html += `<p class="meta-field"><b>${prefix + key}:</b> ${obj[key] !== null && obj[key] !== undefined ? obj[key] : "-"}</p>`;
            }
          }
          return html;
        }

        const details = renderMetadata(metadata);

        // Determine preview for image/audio
        let preview = "";
        if (file.file_type === "image") {
          preview = `<img src="files/image/${file.filename}" alt="${file.filename}" class="file-preview">`;
        } else if (file.file_type === "audio") {
          preview = `<audio controls class="file-preview">
                      <source src="files/audio/${file.filename}" type="audio/mpeg">
                      Din webbläsare stödjer inte ljuduppspelning.
                    </audio>`;
        }

        return `
          <div class="result-card">
            <h3>${file.filename}</h3>
            <p><b>Typ:</b> ${file.file_type}</p>
            ${preview}
            ${details}
          </div>
        `;
      }).join('');
    }
  </script>
</body>

</html>